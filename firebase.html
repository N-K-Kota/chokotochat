<!DOCTYPE html>
<html>
<head>
  <title>ちょこっとチャット</title>
  <meta charset="UTF8">
  <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous">

</script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyALJheVmhHzkkbVwyW2rD9SQFB8hnnXWiI",
    authDomain: "fir-chat-f4734.firebaseapp.com",
    databaseURL: "https://fir-chat-f4734.firebaseio.com",
    projectId: "fir-chat-f4734",
    storageBucket: "fir-chat-f4734.appspot.com",
    messagingSenderId: "83041435326"
  };
  firebase.initializeApp(config);
  firebase.auth().onAuthStateChanged(function(user){
    if(user){

    }else{
      window.location.href="index.html";
    }
  });
$(function(){
      var database = firebase.database();
      var roomname;
      var username;
      var usernum;
      var disref;
      var connectedRef = firebase.database().ref(".info/connected");
           connectedRef.on("value", function(snap) {
             if (snap.val() === true) {

             } else {
               if(usernum == 1){
                 database.ref("roominfo").update({rf:0});
               }

            }
           });
        database.ref("roominfo").once("value").then(function(snapshot) {

         var unum = snapshot.val().usernum+1;
         var rf = snapshot.val().rf;
         username = "u" + unum;
         if(rf == 0){
           var num = snapshot.val().roomnum + 1;
           database.ref("roominfo").update({roomnum:num,rf:1,usernum:unum});
           roomname = "room"+num;
           disref = database.ref("roominfo").onDisconnect().update({usernum: -- unum,rf:0});
           database.ref(roomname+"/usernumber").on("value",function(snap){
             usernum = snap.val().rn;
             if(usernum == 2){
                 disref.cancel();
                 database.ref("roominfo").onDisconnect().update({usernum: --unum});
             }
           });
           database.ref(roomname+"/usernumber").update({rn:1});

           alert("firstmem");
        } else {
             alert("secondmem");
             database.ref("roominfo").update({rf:0,usernum:unum});
             roomname = "room"+snapshot.val().roomnum;
             database.ref(roomname+"/usernumber").on("value",function(snap){
               usernum = snap.val().rn;
               alert(usernum);
             });
             database.ref(roomname+"/usernumber").update({rn:2});
             database.ref("roominfo").onDisconnect().update({usernum: -- unum});
        }


        database.ref(roomname).on("child_added" ,function(content){
          if(content.val().text != null){
           $("#textarea").append("<li>"+content.val().text+"</li>");
         }

        });



        });



    document.fm.btnfom.onclick=function(){
      var textval=document.fm.textfm.value;
      database.ref(roomname).push({text:textval});
      alert("writed");
     };
    $("#logout").on("click",function(){
      firebase.auth().signOut().then(function(){
         window.location.href="index.html";
      }).catch(function(error){
        consol.log(error);
      });
    });

  });
</script>
</head>
<body>
  <button type="button" id="logout">ログアウト</button>
  <form name="fm">
    <input type="text" name="textfm">
    <input type="button" name="btnfom" value="write">
  </form>
  <div id="area">
  </div>
 <ul id="textarea">
 </ul>
</body>
</html>
